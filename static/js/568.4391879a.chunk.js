"use strict";(self.webpackChunksupabase_sales_app=self.webpackChunksupabase_sales_app||[]).push([[568],{63568:(e,t,n)=>{n.r(t),n.d(t,{default:()=>X});var s=n(89379),r=n(65043),o=n(35475),i=n(96446),l=n(85865),a=n(43845),c=n(5146),d=n(17392),u=n(19252),x=n(11906),h=n(68903),p=n(63336),m=n(27108),y=n(51787),g=n(81637),A=n(79650),j=n(71806),b=n(84882),f=n(28076),v=n(10039),_=n(73460),S=n(12110),w=n(26494),C=n(39336),k=n(90035),F=n(26600),z=n(35316),R=n(29347),I=n(51387),D=n(17673),P=n(79484),T=n(99010),W=n(58931),q=n(47111),N=n(47503),E=n(27001),V=n(12807),O=n(11737),K=n(90990),U=n(44676),L=n(47968),B=n(31308),M=n(37762),H=n(64857),G=n(70579);function Q(){const{settings:e}=(0,O.A)(),[t,n]=(0,r.useState)([]),[s,o]=(0,r.useState)(0),[a,c]=(0,r.useState)(!0),[d,u]=(0,r.useState)(!1);async function h(){const{data:{session:e}}=await E.N.auth.getSession();if(!e)return;const t=e.user.id,s=new Date,r=s.getFullYear(),i=String(s.getMonth()+1).padStart(2,"0"),l=String(s.getDate()).padStart(2,"0"),a="".concat(r,"-").concat(i,"-").concat(l),{data:d,error:u}=await E.N.from("sales").select("*, products(name)").eq("organization_id",t).eq("sale_date",a).is("deleted_at",null);if(u)return void console.error("Error fetching today sales:",u);n(d||[]);const x=(d||[]).reduce((e,t)=>e+t.quantity*t.price_at_sale,0);o(x),c(!1)}(0,r.useEffect)(()=>{h();const{data:{subscription:e}}=E.N.auth.onAuthStateChange((e,t)=>{("SIGNED_IN"===e||t)&&h()}),t=E.N.channel("public:sales").on("postgres_changes",{event:"INSERT",schema:"public",table:"sales"},()=>{h()}).subscribe();return()=>{t.unsubscribe(),e.unsubscribe()}},[]);return(0,G.jsx)(S.A,{sx:{height:"100%",background:"linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)",color:"white"},children:(0,G.jsxs)(w.A,{children:[(0,G.jsxs)(i.A,{display:"flex",alignItems:"center",gap:1,mb:2,children:[(0,G.jsx)(U.A,{}),(0,G.jsx)(l.A,{variant:"h6",fontWeight:600,children:"Today's Sales"})]}),(0,G.jsx)(l.A,{variant:"h3",fontWeight:700,mb:1,children:(0,V.vv)(s,e.currency_symbol)}),(0,G.jsxs)(l.A,{variant:"body2",sx:{opacity:.8,mb:3},children:[t.length," transactions today"]}),(0,G.jsx)(C.A,{sx:{borderColor:"rgba(255,255,255,0.2)",mb:2}}),(0,G.jsxs)(i.A,{display:"flex",gap:1,children:[(0,G.jsx)(x.A,{variant:"contained",color:"secondary",fullWidth:!0,size:"large",sx:{minHeight:48},startIcon:d?(0,G.jsx)(g.A,{size:20,color:"inherit"}):(0,G.jsx)(L.A,{}),onClick:async()=>{if(0!==t.length){u(!0);try{const n=new M.Ay,r=(new Date).toLocaleDateString(),o=(null===e||void 0===e?void 0:e.store_name)||"Medical Store",i=(null===e||void 0===e?void 0:e.currency_symbol)||"$";n.setFontSize(20),n.text(o,105,15,{align:"center"}),n.setFontSize(14),n.text("Daily Sales Report - ".concat(r),105,25,{align:"center"}),n.setFontSize(12),n.text("Total Sales Count: ".concat(t.length),14,35),n.text("Total Revenue: ".concat((0,V.vv)(s,i)),14,42);const l=["Time","Product","Qty","Unit","Price","Total"],a=t.map(e=>{var t;return[new Date(e.created_at).toLocaleTimeString(),(null===(t=e.products)||void 0===t?void 0:t.name)||"Unknown Product",e.quantity,"box"===e.selling_unit?"Box":"Item",(0,V.vv)(e.price_at_sale,i),(0,V.vv)(e.quantity*e.price_at_sale,i)]});(0,H.Ay)(n,{head:[l],body:a,startY:50,styles:{fontSize:10},headStyles:{fillColor:[99,102,241]}});const c=n.lastAutoTable&&n.lastAutoTable.finalY||50;n.setFontSize(10),n.text("_______________________",150,c+30),n.text("Authorized Signature",150,c+40),n.save("daily_sales_".concat(r.replace(/\//g,"-"),".pdf")),N.oR.success("PDF downloaded successfully!")}catch(n){console.error("Error generating PDF:",n),N.oR.error("Failed to generate PDF: ".concat(n.message))}finally{u(!1)}}else N.oR.info("No sales to report for today.")},disabled:a||0===t.length||d,children:"PDF"}),(0,G.jsx)(x.A,{variant:"outlined",fullWidth:!0,size:"large",sx:{minHeight:48,borderColor:"white",color:"white","&:hover":{borderColor:"white",backgroundColor:"rgba(255,255,255,0.1)"}},startIcon:d?(0,G.jsx)(g.A,{size:20,color:"inherit"}):(0,G.jsx)(B.A,{}),onClick:()=>{if(0!==t.length){u(!0);try{const n=(new Date).toLocaleDateString();null===e||void 0===e||e.currency_symbol;let r="Time,Product,Quantity,Unit,Price,Total,Payment Method,Customer\n";t.forEach(e=>{var t,n;const s=new Date(e.created_at).toLocaleTimeString(),o=((null===(t=e.products)||void 0===t?void 0:t.name)||"Unknown Product").replace(/"/g,'""'),i=e.quantity,l="box"===e.selling_unit?"Box":"Item",a=e.price_at_sale,c=i*a,d=e.payment_method||"N/A",u=(null===(n=e.customers)||void 0===n?void 0:n.name)||"Walk-in";r+='"'.concat(s,'","').concat(o,'",').concat(i,',"').concat(l,'",').concat(a,",").concat(c,',"').concat(d,'","').concat(u,'"\n')}),r+='\n"Summary",,,,,,\n',r+='"Total Transactions",'.concat(t.length,",,,,,\n"),r+='"Total Revenue",'.concat(s,",,,,,\n");const o=new Blob([r],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a"),l=URL.createObjectURL(o);i.setAttribute("href",l),i.setAttribute("download","daily_sales_".concat(n.replace(/\//g,"-"),".csv")),i.style.visibility="hidden",document.body.appendChild(i),i.click(),document.body.removeChild(i),N.oR.success("CSV downloaded successfully!")}catch(n){console.error("Error generating CSV:",n),N.oR.error("Failed to generate CSV: ".concat(n.message))}finally{u(!1)}}else N.oR.info("No sales to export for today.")},disabled:a||0===t.length||d,children:"CSV"})]})]})})}var Y=n(88249);function X(){const{settings:e}=(0,O.A)(),[t]=(0,o.ok)(),[n,U]=(0,r.useState)([]),[L,B]=(0,r.useState)([]),[M,H]=(0,r.useState)(!1),[X,$]=(0,r.useState)(!1),[J,Z]=(0,r.useState)({invoice:null,items:[]}),[ee,te]=(0,r.useState)(!1),[ne,se]=(0,r.useState)([]),[re,oe]=(0,r.useState)(null),[ie,le]=(0,r.useState)(null),[ae,ce]=(0,r.useState)("0"),[de,ue]=(0,r.useState)("cash"),[xe,he]=(0,r.useState)(t.get("date")||(new Date).toISOString().split("T")[0]),[pe,me]=(0,r.useState)(""),ye=(0,r.useRef)(null),ge=(0,r.useRef)(null),Ae=(0,r.useRef)(null),je=(0,r.useRef)(null);(0,r.useEffect)(()=>{!async function(){const{data:{session:e}}=await E.N.auth.getSession();if(!e)return;const t=e.user.id,{data:n}=await E.N.from("customers").select("*").eq("organization_id",t).is("deleted_at",null).order("name");B(n||[])}(),ye.current&&ye.current.focus()},[]);const be=(e,t,n)=>{se(s=>{const r=[...s],o=r[e];if("quantity"===t){const e=parseInt(n)||0;if(("box"===o.selling_unit?e*(o.product.items_per_box||1):e)>o.product.stock)return N.oR.error("Cannot add more than ".concat(o.product.stock," items.")),s;o.quantity=e,o.total=e*o.price}else if("price"===t){const e=parseFloat(n)||0;o.price=e,o.total=o.quantity*e}else if("selling_unit"===t){const e=n;o.selling_unit=e,o.price="box"===e?parseFloat(o.product.price_per_box||o.product.price*(o.product.items_per_box||1)):parseFloat(o.product.price),o.total=o.quantity*o.price}return r})},fe=()=>ne.reduce((e,t)=>e+t.total,0)-(parseFloat(ae)||0),ve=async()=>{if(0!==ne.length){H(!0);try{const{data:{session:e}}=await E.N.auth.getSession();if(!e)throw new Error("Not authenticated");const t=fe(),n=parseFloat(ae)||0,{data:r,error:o}=await E.N.from("invoices").insert([{customer_id:(null===re||void 0===re?void 0:re.id)||null,total_amount:t,discount:n,payment_method:de,notes:pe,organization_id:e.user.id}]).select().single();if(o)throw o;const i=ne.map(t=>({invoice_id:r.id,product_id:t.product.id,quantity:t.quantity,price_at_sale:t.price,sale_date:xe,organization_id:e.user.id,selling_unit:t.selling_unit,items_per_box:t.product.items_per_box})),{error:l}=await E.N.from("sales").insert(i);if(l)throw l;for(const s of ne){const e="box"===s.selling_unit?s.quantity*(s.product.items_per_box||1):s.quantity;await E.N.rpc("decrease_stock",{p_id:s.product.id,q_sold:e})}N.oR.success("Sale completed!"),Z({invoice:(0,s.A)({},r),items:ne.map(e=>(0,s.A)((0,s.A)({},e),{},{products:e.product}))}),$(!0),se([]),ce("0"),me(""),oe(null),ye.current&&ye.current.focus()}catch(e){console.error("Checkout error:",e),N.oR.error(e.message)}finally{H(!1)}}else N.oR.error("Cart is empty")},_e=(e,t)=>{var n;"Enter"===e.key&&(e.preventDefault(),null===(n=ye.current)||void 0===n||n.focus())};(0,K.A)({F2:()=>{var e;return null===(e=ye.current)||void 0===e?void 0:e.focus()},F3:()=>{var e;return null===(e=je.current)||void 0===e?void 0:e.focus()},F4:()=>ve(),F8:()=>(e=>{if(e<0||e>=ne.length)return;const t="box"===ne[e].selling_unit?"item":"box";be(e,"selling_unit",t)})(ne.length-1),F9:()=>{var e;return null===(e=ge.current)||void 0===e?void 0:e.focus()},Escape:()=>{var e;(le(null),document.activeElement===ye.current)?ye.current.blur():null===(e=ye.current)||void 0===e||e.focus()},"Shift+?":()=>te(!0)});const Se=(0,r.useMemo)(()=>[{header:"Product",accessorKey:"product.name",cell:e=>(0,G.jsxs)(i.A,{children:[(0,G.jsx)(l.A,{variant:"body2",fontWeight:"bold",children:e.getValue()}),(0,G.jsxs)(l.A,{variant:"caption",color:"text.secondary",children:["Stock: ",e.row.original.product.stock," | Exp: ",e.row.original.product.expiry_date||"N/A"]})]})},{header:"Stock",accessorKey:"product.stock",cell:e=>(0,G.jsx)(l.A,{variant:"body2",color:e.getValue()<10?"error":"text.primary",children:e.getValue()})},{header:"Unit",accessorKey:"selling_unit",cell:e=>(0,G.jsx)(a.A,{label:e.getValue().toUpperCase(),size:"small",color:"box"===e.getValue()?"secondary":"default",variant:"outlined",onClick:()=>{const t="box"===e.getValue()?"item":"box";be(e.row.index,"selling_unit",t)},sx:{cursor:"pointer",minWidth:60}})},{header:"Price",accessorKey:"price",cell:e=>(0,G.jsx)(c.A,{type:"number",variant:"standard",size:"small",value:e.getValue(),onChange:t=>be(e.row.index,"price",t.target.value),onKeyDown:t=>_e(t,e.row.index),InputProps:{disableUnderline:!0},sx:{width:80}})},{header:"Qty",accessorKey:"quantity",cell:e=>(0,G.jsx)(c.A,{type:"number",variant:"outlined",size:"small",autoFocus:e.row.index===ne.length-1,value:e.getValue(),onChange:t=>be(e.row.index,"quantity",t.target.value),onKeyDown:t=>_e(t,e.row.index),sx:{width:80},inputProps:{min:1}})},{header:"Total",accessorKey:"total",cell:t=>(0,G.jsx)(l.A,{fontWeight:"bold",children:(0,V.vv)(t.getValue(),e.currency_symbol)})},{id:"actions",cell:e=>(0,G.jsx)(d.A,{color:"error",size:"small",onClick:()=>{return t=e.row.index,void se(e=>e.filter((e,n)=>n!==t));var t},children:(0,G.jsx)(I.A,{fontSize:"small"})})}],[ne,e.currency_symbol]),we=(0,W.N4)({data:ne,columns:Se,getCoreRowModel:(0,q.HT)()});return(0,G.jsxs)(u.A,{maxWidth:"xl",sx:{pb:4},children:[(0,G.jsxs)(i.A,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[(0,G.jsx)(l.A,{variant:"h5",fontWeight:700,color:"primary",children:"Sales Terminal"}),(0,G.jsx)(x.A,{startIcon:(0,G.jsx)(D.A,{}),onClick:()=>te(!0),size:"small",children:"Shortcuts"})]}),(0,G.jsxs)(h.Ay,{container:!0,spacing:2,children:[(0,G.jsxs)(h.Ay,{item:!0,xs:12,lg:8,order:{xs:2,lg:1},children:[" ",(0,G.jsx)(p.A,{sx:{p:2,mb:2},children:(0,G.jsxs)(h.Ay,{container:!0,spacing:2,alignItems:"center",children:[(0,G.jsx)(h.Ay,{item:!0,xs:12,md:8,children:(0,G.jsx)(m.A,{id:"product-search",options:n,getOptionLabel:e=>e.name,filterOptions:e=>e,value:ie,onChange:(e,t)=>{t&&(e=>{if(!e)return;const t="box"===e.selling_unit?"box":"item",n="box"===t?e.price_per_box||e.price*(e.items_per_box||1):e.price;se(s=>{const r=s.findIndex(n=>n.product.id===e.id&&n.selling_unit===t);if(r>=0){const t=[...s],n=t[r].quantity+1;return("box"===t[r].selling_unit?n*(e.items_per_box||1):n)>e.stock?(N.oR.error("Out of Stock! Only ".concat(e.stock," items available.")),s):(t[r].quantity=n,t[r].total=t[r].quantity*t[r].price,t)}return("box"===t&&e.items_per_box||1)>e.stock?(N.oR.error("Out of Stock! Only ".concat(e.stock," items available.")),s):[...s,{product:e,quantity:1,price:parseFloat(n),selling_unit:t,total:parseFloat(n)}]}),le(null),ye.current&&ye.current.focus(),N.oR.success("Added ".concat(e.name))})(t)},onInputChange:(e,t)=>{"change"===(null===e||void 0===e?void 0:e.type)&&(async e=>{if(!e||e.length<2)U([]);else{H(!0);try{const{data:t,error:n}=await E.N.rpc("search_products",{search_term:e,p_limit:50});if(n)throw n;U(t||[])}catch(t){console.error("Error searching products:",t),U([])}finally{H(!1)}}})(t)},renderInput:e=>(0,G.jsx)(c.A,(0,s.A)((0,s.A)({},e),{},{inputRef:ye,label:"Scan Barcode or Search Product (F2)",placeholder:"Type product name...",fullWidth:!0,size:"small",InputProps:(0,s.A)((0,s.A)({},e.InputProps),{},{startAdornment:(0,G.jsx)(y.A,{position:"start",children:(0,G.jsx)(P.A,{color:"action"})}),endAdornment:(0,G.jsxs)(G.Fragment,{children:[M?(0,G.jsx)(g.A,{size:20}):null,e.InputProps.endAdornment]})})})),renderOption:(t,n)=>(0,G.jsx)("li",(0,s.A)((0,s.A)({},t),{},{children:(0,G.jsxs)(i.A,{display:"flex",justifyContent:"space-between",width:"100%",children:[(0,G.jsxs)(i.A,{children:[(0,G.jsx)(l.A,{variant:"body1",children:n.name}),(0,G.jsx)(l.A,{variant:"caption",color:"text.secondary",children:n.category})]}),(0,G.jsxs)(i.A,{textAlign:"right",children:[(0,G.jsxs)(l.A,{variant:"body2",color:n.stock<10?"error.main":"success.main",children:[n.stock," in stock"]}),(0,G.jsx)(l.A,{variant:"body2",fontWeight:"bold",children:(0,V.vv)(n.price,e.currency_symbol)})]})]})}))})}),(0,G.jsx)(h.Ay,{item:!0,xs:12,md:4,children:(0,G.jsx)(m.A,{options:L,getOptionLabel:e=>e.name,value:re,onChange:(e,t)=>oe(t),renderInput:e=>(0,G.jsx)(c.A,(0,s.A)((0,s.A)({},e),{},{inputRef:je,label:"Customer (Optional) (F3)",fullWidth:!0,size:"small"}))})})]})}),(0,G.jsx)(p.A,{sx:{width:"100%",overflow:"hidden"},children:(0,G.jsx)(i.A,{sx:{overflowX:"auto",width:"100%"},children:(0,G.jsxs)(A.A,{sx:{maxHeight:"60vh",minWidth:650},children:[" ",(0,G.jsxs)(j.A,{stickyHeader:!0,size:"small",children:[(0,G.jsx)(b.A,{children:we.getHeaderGroups().map(e=>(0,G.jsx)(f.A,{children:e.headers.map(e=>(0,G.jsx)(v.A,{sx:{fontWeight:"bold",bgcolor:"background.default",whiteSpace:"nowrap"},children:(0,W.Kv)(e.column.columnDef.header,e.getContext())},e.id))},e.id))}),(0,G.jsx)(_.A,{children:0===we.getRowModel().rows.length?(0,G.jsx)(f.A,{children:(0,G.jsx)(v.A,{colSpan:7,align:"center",sx:{py:8},children:(0,G.jsx)(l.A,{color:"text.secondary",children:"No items in cart. Search to add products."})})}):we.getRowModel().rows.map(e=>(0,G.jsx)(f.A,{hover:!0,children:e.getVisibleCells().map(e=>(0,G.jsx)(v.A,{children:(0,W.Kv)(e.column.columnDef.cell,e.getContext())},e.id))},e.id))})]})]})})})]}),(0,G.jsx)(h.Ay,{item:!0,xs:12,lg:4,order:{xs:1,lg:2},children:(0,G.jsxs)(i.A,{sx:{display:"flex",flexDirection:"column",height:"100%",gap:2},children:[(0,G.jsx)(S.A,{elevation:3,sx:{display:"flex",flexDirection:"column",borderRadius:2},children:(0,G.jsxs)(w.A,{sx:{p:3},children:[(0,G.jsx)(l.A,{variant:"h6",fontWeight:600,gutterBottom:!0,color:"primary.main",children:"Sale Summary"}),(0,G.jsx)(i.A,{my:3,children:(0,G.jsxs)(h.Ay,{container:!0,spacing:2,children:[(0,G.jsx)(h.Ay,{item:!0,xs:6,children:(0,G.jsx)(l.A,{variant:"body1",color:"text.secondary",children:"Subtotal"})}),(0,G.jsx)(h.Ay,{item:!0,xs:6,textAlign:"right",children:(0,G.jsx)(l.A,{variant:"h6",fontWeight:500,children:(0,V.vv)(ne.reduce((e,t)=>e+t.total,0),e.currency_symbol)})}),(0,G.jsx)(h.Ay,{item:!0,xs:12,children:(0,G.jsx)(c.A,{label:"Discount (F9)",fullWidth:!0,size:"small",type:"number",value:ae,onChange:e=>ce(e.target.value),inputRef:ge,InputLabelProps:{shrink:!0},sx:{mt:1}})}),(0,G.jsx)(h.Ay,{item:!0,xs:12,children:(0,G.jsxs)(c.A,{select:!0,label:"Payment Method",fullWidth:!0,size:"small",SelectProps:{native:!0},value:de,onChange:e=>ue(e.target.value),sx:{mt:1},children:[(0,G.jsx)("option",{value:"cash",children:"Cash"}),(0,G.jsx)("option",{value:"card",children:"Card"}),(0,G.jsx)("option",{value:"online",children:"Online"})]})}),(0,G.jsxs)(h.Ay,{item:!0,xs:12,children:[(0,G.jsx)(C.A,{sx:{my:2}}),(0,G.jsxs)(i.A,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[(0,G.jsx)(l.A,{variant:"h5",fontWeight:700,color:"text.primary",children:"Total"}),(0,G.jsx)(l.A,{variant:"h4",fontWeight:800,color:"primary.main",children:(0,V.vv)(fe(),e.currency_symbol)})]})]})]})}),(0,G.jsx)(x.A,{variant:"contained",color:"primary",fullWidth:!0,size:"large",startIcon:(0,G.jsx)(T.A,{}),onClick:ve,disabled:0===ne.length||M,ref:Ae,sx:{py:2,fontSize:"1.2rem",fontWeight:"bold",borderRadius:2,boxShadow:4,textTransform:"none"},children:M?"Processing...":"Complete Sale (F4)"})]})}),(0,G.jsxs)(i.A,{sx:{flexGrow:1,display:{xs:"none",md:"block"}},children:[" ",(0,G.jsx)(Q,{})]})]})})]}),(0,G.jsx)(i.A,{mt:2,display:{xs:"block",md:"none"},children:(0,G.jsx)(Q,{})}),(0,G.jsxs)(k.A,{open:ee,onClose:()=>te(!1),children:[(0,G.jsx)(F.A,{children:"Keyboard Shortcuts"}),(0,G.jsx)(z.A,{children:(0,G.jsxs)(h.Ay,{container:!0,spacing:2,children:[(0,G.jsx)(h.Ay,{item:!0,xs:6,children:(0,G.jsx)(a.A,{label:"F2",size:"small"})}),(0,G.jsx)(h.Ay,{item:!0,xs:6,children:(0,G.jsx)(l.A,{children:"Focus Search Bar"})}),(0,G.jsx)(h.Ay,{item:!0,xs:6,children:(0,G.jsx)(a.A,{label:"F3",size:"small"})}),(0,G.jsx)(h.Ay,{item:!0,xs:6,children:(0,G.jsx)(l.A,{children:"Select Customer"})}),(0,G.jsx)(h.Ay,{item:!0,xs:6,children:(0,G.jsx)(a.A,{label:"F4",size:"small"})}),(0,G.jsx)(h.Ay,{item:!0,xs:6,children:(0,G.jsx)(l.A,{children:"Complete Sale / Pay"})}),(0,G.jsx)(h.Ay,{item:!0,xs:6,children:(0,G.jsx)(a.A,{label:"F9",size:"small"})}),(0,G.jsx)(h.Ay,{item:!0,xs:6,children:(0,G.jsx)(l.A,{children:"Focus Discount Field"})}),(0,G.jsx)(h.Ay,{item:!0,xs:6,children:(0,G.jsx)(a.A,{label:"F8",size:"small"})}),(0,G.jsx)(h.Ay,{item:!0,xs:6,children:(0,G.jsx)(l.A,{children:"Toggle Unit (Item/Box)"})}),(0,G.jsx)(h.Ay,{item:!0,xs:6,children:(0,G.jsx)(a.A,{label:"Esc",size:"small"})}),(0,G.jsx)(h.Ay,{item:!0,xs:6,children:(0,G.jsx)(l.A,{children:"Clear Selection / Blur"})})]})}),(0,G.jsx)(R.A,{children:(0,G.jsx)(x.A,{onClick:()=>te(!1),children:"Close"})})]}),(0,G.jsx)(Y.A,{open:X,onClose:()=>$(!1),invoice:J.invoice,items:J.items,settings:e})]})}}}]);
//# sourceMappingURL=568.4391879a.chunk.js.map