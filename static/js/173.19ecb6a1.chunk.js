"use strict";(self.webpackChunksupabase_sales_app=self.webpackChunksupabase_sales_app||[]).push([[173],{3632:(e,t,n)=>{n.d(t,{A:()=>o});var r=n(59662),i=n(70579);const o=(0,r.A)((0,i.jsx)("path",{d:"M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5M12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5m0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"}),"Visibility")},12807:(e,t,n)=>{function r(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"PKR";if(null===e||void 0===e||isNaN(e))return"".concat(t," 0.00");const n=Number(e);return"".concat(t," ").concat(n.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}))}function i(e){return null===e||void 0===e||isNaN(e)?"0":Number(e).toLocaleString("en-US")}function o(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return null===e||void 0===e||isNaN(e)?"0%":"".concat(Number(e).toFixed(t),"%")}n.d(t,{Ee:()=>o,ZV:()=>i,vv:()=>r})},68173:(e,t,n)=>{n.r(t),n.d(t,{default:()=>me});var r=n(65043),i=n(26240),o=n(30344),s=n(19252),a=n(96446),l=n(85865),d=n(11906),c=n(12110),p=n(26494),u=n(5146),x=n(51787),h=n(32143),m=n(79650),_=n(71806),g=n(84882),A=n(28076),f=n(10039),v=n(73460),j=n(43845),y=n(77739),b=n(17392),w=n(19090),S=n(83560),C=n(59662),P=n(70579);const R=(0,C.A)((0,P.jsx)("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"}),"Send");var O=n(71403),q=n(98606),z=n(17673),D=n(70141),k=n(79484),F=n(3632),I=n(51387),W=n(47503),N=n(27001),L=n(12807),E=n(89379),T=n(90035),U=n(26600),B=n(35316),M=n(68903),H=n(39336),K=n(27108),V=n(29347),J=n(99010);function Q(e){let{open:t,onClose:n,purchaseOrder:s,suppliers:x}=e;const j=!!s,y=(0,i.A)(),w=(0,o.A)(y.breakpoints.down("sm")),[S,C]=(0,r.useState)({supplier_id:"",order_date:(new Date).toISOString().split("T")[0],notes:""}),[R,O]=(0,r.useState)([]),[q,z]=(0,r.useState)([]),[k,F]=(0,r.useState)(!1),[L,Q]=(0,r.useState)([]),[Y,G]=(0,r.useState)(!1);(0,r.useEffect)(()=>{t&&(X(),j?ee():te())},[t,s]);const X=async()=>{const{data:{session:e}}=await N.N.auth.getSession();if(!e)return;const{data:t}=await N.N.from("products").select("*").eq("organization_id",e.user.id).is("deleted_at",null).order("name");z(t||[]),Q(t||[])},Z=async e=>{if(!e||e.length<2)Q(q);else{G(!0);try{const t=q.filter(t=>t.name.toLowerCase().includes(e.toLowerCase())),{data:n}=await N.N.from("medicine_reference").select("*").or("brand_name.ilike.%".concat(e,"%,generic_name.ilike.%").concat(e,"%")).limit(20),r=(null===n||void 0===n?void 0:n.filter(e=>!q.some(t=>t.name.toLowerCase()===e.brand_name.toLowerCase())).map(e=>(0,E.A)((0,E.A)({},e),{},{id:"REF-".concat(e.id),isReference:!0,name:e.brand_name,items_per_box:e.standard_packaging?$(e.standard_packaging):1})))||[];Q([...t,...r])}catch(t){console.error("Error searching:",t),Q(q)}finally{G(!1)}}},$=e=>{if(!e)return 1;const t=e.match(/(\d+)\s*(tablets?|items?|capsules?)/i);return t?parseInt(t[1]):1},ee=async()=>{if(!s)return;C({supplier_id:s.supplier_id||"",order_date:s.order_date||(new Date).toISOString().split("T")[0],notes:s.notes||""});const{data:e}=await N.N.from("purchase_order_items").select("*, products(name)").eq("purchase_order_id",s.id);e&&O(e.map(e=>{var t;return{product_id:e.product_id,product_name:null===(t=e.products)||void 0===t?void 0:t.name,quantity_ordered:e.quantity_ordered,boxes_ordered:e.boxes_ordered||"",items_per_box:e.items_per_box||1}}))},te=()=>{C({supplier_id:"",order_date:(new Date).toISOString().split("T")[0],notes:""}),O([])},ne=e=>{C((0,E.A)((0,E.A)({},S),{},{[e.target.name]:e.target.value}))},re=()=>{O([...R,{product_id:"",product_name:"",quantity_ordered:1,boxes_ordered:"",items_per_box:1}])},ie=e=>{O(R.filter((t,n)=>n!==e))},oe=(e,t,n)=>{const r=[...R];if(r[e][t]=n,"product_id"===t){const t=q.find(e=>e.id===n);t&&(r[e].product_name=t.name,r[e].items_per_box=t.items_per_box||1,r[e].boxes_ordered&&(r[e].quantity_ordered=r[e].boxes_ordered*(t.items_per_box||1)))}if("boxes_ordered"===t||"items_per_box"===t){const i="boxes_ordered"===t?n:r[e].boxes_ordered,o="items_per_box"===t?n:r[e].items_per_box;i&&o&&(r[e].quantity_ordered=parseInt(i)*parseInt(o))}O(r)},se=(e,t)=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),t===R.length-1&&re())};return(0,P.jsxs)(T.A,{open:t,onClose:()=>n(),maxWidth:"md",fullWidth:!0,children:[(0,P.jsx)(U.A,{children:(0,P.jsxs)(a.A,{display:"flex",alignItems:"center",gap:1,children:[(0,P.jsx)(J.A,{color:"primary"}),j?"Edit Purchase Order":"Create Purchase Order"]})}),(0,P.jsx)(B.A,{children:(0,P.jsxs)(M.Ay,{container:!0,spacing:2,sx:{mt:1},children:[(0,P.jsx)(M.Ay,{item:!0,xs:12,sm:6,children:(0,P.jsx)(u.A,{select:!0,fullWidth:!0,required:!0,label:"Supplier",name:"supplier_id",value:S.supplier_id,onChange:ne,children:x.map(e=>(0,P.jsx)(h.A,{value:e.id,children:e.name},e.id))})}),(0,P.jsx)(M.Ay,{item:!0,xs:12,sm:6,children:(0,P.jsx)(u.A,{fullWidth:!0,required:!0,type:"date",label:"Order Date",name:"order_date",value:S.order_date,onChange:ne,InputLabelProps:{shrink:!0}})}),(0,P.jsxs)(M.Ay,{item:!0,xs:12,children:[(0,P.jsx)(H.A,{sx:{my:1}}),(0,P.jsxs)(a.A,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[(0,P.jsx)(l.A,{variant:"h6",children:"Items to Order"}),(0,P.jsx)(d.A,{startIcon:(0,P.jsx)(D.A,{}),onClick:re,children:"Add Item"})]}),w?(0,P.jsx)(a.A,{children:R.map((e,t)=>(0,P.jsx)(c.A,{variant:"outlined",sx:{mb:2},children:(0,P.jsx)(p.A,{children:(0,P.jsxs)(M.Ay,{container:!0,spacing:2,children:[(0,P.jsx)(M.Ay,{item:!0,xs:12,children:(0,P.jsxs)(a.A,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1,children:[(0,P.jsxs)(l.A,{variant:"subtitle2",fontWeight:600,children:["Item #",t+1]}),(0,P.jsx)(b.A,{size:"small",color:"error",onClick:()=>ie(t),children:(0,P.jsx)(I.A,{fontSize:"small"})})]})}),(0,P.jsx)(M.Ay,{item:!0,xs:12,children:(0,P.jsx)(K.A,{size:"small",freeSolo:!0,options:L,loading:Y,getOptionLabel:e=>"string"===typeof e?e:e.name||"",value:q.find(t=>t.id===e.product_id)||(e.product_name?{name:e.product_name}:null),onInputChange:(e,t)=>{Z(t)},onChange:(e,n)=>{let r="",i="",o=1;"string"===typeof n?(r="CUSTOM-".concat(Date.now()),i=n):n&&(r=n.id,i=n.name,o=n.items_per_box||1);const s=[...R];s[t].product_id=r,s[t].product_name=i,s[t].items_per_box=o,s[t].boxes_ordered="",s[t].quantity_ordered=1,O(s)},renderInput:e=>(0,P.jsx)(u.A,(0,E.A)((0,E.A)({},e),{},{label:"Product",placeholder:"Search or type new...",helperText:"Select or type new product name"})),renderOption:(e,t)=>(0,P.jsx)("li",(0,E.A)((0,E.A)({},e),{},{children:(0,P.jsxs)(a.A,{children:[(0,P.jsxs)(l.A,{variant:"body2",fontWeight:t.isReference?600:400,children:[t.name,t.isReference&&(0,P.jsx)("span",{style:{color:"green",fontSize:"0.8em",marginLeft:8},children:"(Database)"}),!t.isReference&&!t.id&&(0,P.jsx)("span",{style:{color:"orange",fontSize:"0.8em",marginLeft:8},children:"(New)"})]}),t.generic_name&&(0,P.jsx)(l.A,{variant:"caption",color:"text.secondary",children:t.generic_name})]})}))})}),(0,P.jsx)(M.Ay,{item:!0,xs:6,children:(0,P.jsx)(u.A,{size:"small",fullWidth:!0,type:"number",label:"Boxes",placeholder:"Boxes",value:e.boxes_ordered,onChange:e=>oe(t,"boxes_ordered",e.target.value),onKeyDown:e=>se(e,t),inputProps:{min:1}})}),(0,P.jsx)(M.Ay,{item:!0,xs:6,children:(0,P.jsx)(u.A,{size:"small",fullWidth:!0,type:"number",label:"Items/Box",placeholder:"Per Box",value:e.items_per_box,onChange:e=>oe(t,"items_per_box",e.target.value),onKeyDown:e=>se(e,t),inputProps:{min:1}})}),(0,P.jsx)(M.Ay,{item:!0,xs:12,children:(0,P.jsx)(u.A,{size:"small",fullWidth:!0,type:"number",label:"Total Items",value:e.quantity_ordered,onChange:e=>oe(t,"quantity_ordered",e.target.value),onKeyDown:e=>se(e,t),inputProps:{min:1},helperText:"Total Units"})})]})})},t))}):(0,P.jsx)(m.A,{children:(0,P.jsxs)(_.A,{size:"small",children:[(0,P.jsx)(g.A,{children:(0,P.jsxs)(A.A,{children:[(0,P.jsx)(f.A,{children:(0,P.jsx)("strong",{children:"Product"})}),(0,P.jsx)(f.A,{width:"100",children:(0,P.jsx)("strong",{children:"Boxes"})}),(0,P.jsx)(f.A,{width:"100",children:(0,P.jsx)("strong",{children:"Items/Box"})}),(0,P.jsx)(f.A,{width:"120",children:(0,P.jsx)("strong",{children:"Total Items"})}),(0,P.jsx)(f.A,{width:"50"})]})}),(0,P.jsx)(v.A,{children:R.map((e,t)=>(0,P.jsxs)(A.A,{children:[(0,P.jsx)(f.A,{children:(0,P.jsx)(K.A,{size:"small",freeSolo:!0,options:L,loading:Y,getOptionLabel:e=>"string"===typeof e?e:e.name||"",value:q.find(t=>t.id===e.product_id)||(e.product_name?{name:e.product_name}:null),onInputChange:(e,t)=>{Z(t)},onChange:(e,n)=>{let r="",i="",o=1;"string"===typeof n?(r="CUSTOM-".concat(Date.now()),i=n):n&&(r=n.id,i=n.name,o=n.items_per_box||1);const s=[...R];s[t].product_id=r,s[t].product_name=i,s[t].items_per_box=o,s[t].boxes_ordered="",s[t].quantity_ordered=1,O(s)},renderInput:e=>(0,P.jsx)(u.A,(0,E.A)((0,E.A)({},e),{},{placeholder:"Search or type new..."})),renderOption:(e,t)=>(0,P.jsx)("li",(0,E.A)((0,E.A)({},e),{},{children:(0,P.jsxs)(a.A,{children:[(0,P.jsxs)(l.A,{variant:"body2",fontWeight:t.isReference?600:400,children:[t.name,t.isReference&&(0,P.jsx)("span",{style:{color:"green",fontSize:"0.8em",marginLeft:8},children:"(Database)"})]}),t.generic_name&&(0,P.jsx)(l.A,{variant:"caption",color:"text.secondary",children:t.generic_name})]})}))})}),(0,P.jsx)(f.A,{children:(0,P.jsx)(u.A,{size:"small",fullWidth:!0,type:"number",placeholder:"Boxes",value:e.boxes_ordered,onChange:e=>oe(t,"boxes_ordered",e.target.value),onKeyDown:e=>se(e,t),inputProps:{min:1}})}),(0,P.jsx)(f.A,{children:(0,P.jsx)(u.A,{size:"small",fullWidth:!0,type:"number",placeholder:"Per Box",value:e.items_per_box,onChange:e=>oe(t,"items_per_box",e.target.value),onKeyDown:e=>se(e,t),inputProps:{min:1}})}),(0,P.jsx)(f.A,{children:(0,P.jsx)(u.A,{size:"small",fullWidth:!0,type:"number",value:e.quantity_ordered,onChange:e=>oe(t,"quantity_ordered",e.target.value),onKeyDown:e=>se(e,t),inputProps:{min:1},helperText:"Total Units"})}),(0,P.jsx)(f.A,{children:(0,P.jsx)(b.A,{size:"small",color:"error",onClick:()=>ie(t),children:(0,P.jsx)(I.A,{fontSize:"small"})})})]},t))})]})})]}),(0,P.jsx)(M.Ay,{item:!0,xs:12,children:(0,P.jsx)(u.A,{fullWidth:!0,multiline:!0,rows:2,label:"Notes (Optional)",name:"notes",value:S.notes,onChange:ne,placeholder:"Any special instructions for the supplier..."})}),(0,P.jsx)(M.Ay,{item:!0,xs:12,children:(0,P.jsx)(a.A,{bgcolor:"info.light",p:2,borderRadius:1,children:(0,P.jsxs)(l.A,{variant:"body2",color:"info.dark",children:[(0,P.jsx)("strong",{children:"Note:"})," Prices will be entered when you receive the stock from the supplier."]})})})]})}),(0,P.jsxs)(V.A,{children:[(0,P.jsx)(d.A,{onClick:()=>n(),children:"Cancel"}),(0,P.jsx)(d.A,{onClick:async()=>{if(S.supplier_id)if(0!==R.length)if(R.some(e=>!e.product_id||e.quantity_ordered<=0))W.oR.error("Please fill in all item details correctly");else{F(!0);try{const{data:{session:e}}=await N.N.auth.getSession();if(!e)throw new Error("Not authenticated");if(j){const{error:t}=await N.N.from("purchase_orders").update({supplier_id:S.supplier_id,order_date:S.order_date,notes:S.notes,updated_at:(new Date).toISOString()}).eq("id",s.id);if(t)throw t;await N.N.from("purchase_order_items").delete().eq("purchase_order_id",s.id);const{error:r}=await N.N.from("purchase_order_items").insert(await Promise.all(R.map(async t=>{let n=t.product_id;if(!q.some(e=>e.id===t.product_id)){const{data:r,error:i}=await N.N.from("products").insert([{organization_id:e.user.id,name:t.product_name,price:0,stock:0,items_per_box:t.items_per_box||1}]).select().single();if(i)throw i;n=r.id}return{purchase_order_id:s.id,product_id:n,quantity_ordered:t.quantity_ordered,boxes_ordered:t.boxes_ordered?parseInt(t.boxes_ordered):null,items_per_box:t.items_per_box?parseInt(t.items_per_box):1,unit_price:0}})));if(r)throw r;W.oR.success("PO updated successfully!"),n()}else{const{data:t}=await N.N.rpc("generate_po_number"),r=t||"PO-".concat(Date.now()),{data:i,error:o}=await N.N.from("purchase_orders").insert([{po_number:r,supplier_id:S.supplier_id,currency_id:null,order_date:S.order_date,status:"draft",notes:S.notes,created_by:e.user.id,organization_id:e.user.id,total_amount:0,final_amount:0}]).select().single();if(o)throw o;const{error:s}=await N.N.from("purchase_order_items").insert(await Promise.all(R.map(async t=>{let n=t.product_id;if(!q.some(e=>e.id===t.product_id)){const{data:r,error:i}=await N.N.from("products").insert([{organization_id:e.user.id,name:t.product_name,price:0,stock:0,items_per_box:t.items_per_box||1}]).select().single();if(i)throw i;n=r.id}return{purchase_order_id:i.id,product_id:n,quantity_ordered:t.quantity_ordered,boxes_ordered:t.boxes_ordered?parseInt(t.boxes_ordered):null,items_per_box:t.items_per_box?parseInt(t.items_per_box):1,unit_price:0}})));if(s)throw s;W.oR.success("Purchase Order created successfully!");const a=R.map(e=>{var t;return(0,E.A)((0,E.A)({},e),{},{product_name:null===(t=q.find(t=>t.id===e.product_id))||void 0===t?void 0:t.name})});n(i,a,x.find(e=>e.id===S.supplier_id))}}catch(e){console.error("Error saving PO:",e),W.oR.error("Failed to save purchase order: "+e.message)}finally{F(!1)}}else W.oR.error("Please add at least one item");else W.oR.error("Please select a supplier")},variant:"contained",disabled:k,children:j?"Update Order":"Create Order"})]})]})}var Y=n(33438),G=n(47968),X=n(68970);function Z(e){let{open:t,onClose:n,purchaseOrder:i,poItems:o}=e;const[s,c]=(0,r.useState)([]),[p,x]=(0,r.useState)((new Date).toISOString().split("T")[0]),[h,y]=(0,r.useState)(""),[b,w]=(0,r.useState)(!1);(0,r.useEffect)(()=>{t&&o&&S()},[t,o]);const S=async()=>{try{const e=o.map(e=>e.product_id),{data:t,error:n}=await N.N.from("products").select("id, price, cost_price, items_per_box").in("id",e);if(n)throw n;const r={};null===t||void 0===t||t.forEach(e=>{r[e.id]=e}),c(o.map(e=>{var t;const n=r[e.product_id];return{po_item_id:e.id,product_id:e.product_id,product_name:e.product_name||(null===(t=e.products)||void 0===t?void 0:t.name),quantity_ordered:e.quantity_ordered,quantity_already_received:e.quantity_received,quantity_remaining:e.quantity_ordered-e.quantity_received,quantity_to_receive:0,unit_price:e.unit_price||(null===n||void 0===n?void 0:n.cost_price)||0,selling_price:(null===n||void 0===n?void 0:n.price)||0,boxes_received:"",items_per_box:e.items_per_box||(null===n||void 0===n?void 0:n.items_per_box)||1,cost_per_box:"",total_cost:"",selling_price_per_box:"",total_selling_price:0}}))}catch(e){console.error("Error fetching product details:",e),W.oR.error("Failed to load product details")}},C=(e,t,n)=>{const r=[...s];if("boxes_received"===t||"items_per_box"===t){r[e][t]=n;const i=parseFloat(r[e].boxes_received)||0,o=parseFloat(r[e].items_per_box)||1;if(i>0){const t=Math.round(i*o),n=r[e].quantity_remaining;r[e].quantity_to_receive=Math.min(t,n)}}else{const t=r[e].quantity_remaining,i=Math.min(parseInt(n)||0,t);r[e].quantity_to_receive=i}c(r)},R=(e,t,n)=>{const r=[...s];r[e][t]=parseFloat(n)||0;const i=parseFloat(r[e].boxes_received)||0,o=parseFloat(r[e].items_per_box)||1,a=i*o;if("total_cost"===t||"boxes_received"===t||"items_per_box"===t){const o=parseFloat("total_cost"===t?n:r[e].total_cost)||0;i>0&&(r[e].cost_per_box=o/i,a>0&&(r[e].unit_price=o/a))}if("selling_price_per_box"===t||"items_per_box"===t||"boxes_received"===t){const s=parseFloat("selling_price_per_box"===t?n:r[e].selling_price_per_box)||0;o>0&&(r[e].selling_price=s/o),i>0&&(r[e].total_selling_price=s*i)}c(r)},q=s.reduce((e,t)=>e+t.quantity_to_receive,0),z=s.reduce((e,t)=>e+(parseFloat(t.total_cost)||0),0);return(0,P.jsxs)(T.A,{open:t,onClose:n,maxWidth:"xl",fullWidth:!0,children:[(0,P.jsx)(U.A,{children:(0,P.jsxs)(a.A,{display:"flex",alignItems:"center",gap:1,children:[(0,P.jsx)(O.A,{color:"primary"}),"Receive Stock - PO: ",null===i||void 0===i?void 0:i.po_number]})}),(0,P.jsx)(B.A,{children:(0,P.jsxs)(M.Ay,{container:!0,spacing:2,sx:{mt:1},children:[(0,P.jsx)(M.Ay,{item:!0,xs:12,children:(0,P.jsx)(u.A,{fullWidth:!0,type:"date",label:"Received Date",value:p,onChange:e=>x(e.target.value),InputLabelProps:{shrink:!0}})}),(0,P.jsx)(M.Ay,{item:!0,xs:12,children:(0,P.jsx)(m.A,{sx:{overflowX:"auto",maxHeight:"60vh"},children:(0,P.jsxs)(_.A,{size:"small",stickyHeader:!0,children:[(0,P.jsx)(g.A,{children:(0,P.jsxs)(A.A,{children:[(0,P.jsx)(f.A,{children:"Product"}),(0,P.jsx)(f.A,{align:"center",children:"Ordered"}),(0,P.jsx)(f.A,{align:"center",children:"Received"}),(0,P.jsx)(f.A,{align:"center",children:"Remaining"}),(0,P.jsx)(f.A,{align:"center",sx:{bgcolor:"#e3f2fd"},children:"Boxes Received"}),(0,P.jsx)(f.A,{align:"center",sx:{bgcolor:"#e3f2fd"},children:"Items/Box"}),(0,P.jsx)(f.A,{align:"center",sx:{bgcolor:"#e3f2fd"},children:"Total Cost"}),(0,P.jsx)(f.A,{align:"center",sx:{bgcolor:"#e3f2fd"},children:"MRP/Box"}),(0,P.jsx)(f.A,{align:"center",sx:{bgcolor:"#f5f5f5"},children:"Total Items"}),(0,P.jsx)(f.A,{align:"center",sx:{bgcolor:"#f5f5f5"},children:"Cost/Box"}),(0,P.jsx)(f.A,{align:"center",sx:{bgcolor:"#f5f5f5"},children:"Cost/Item"}),(0,P.jsx)(f.A,{align:"center",sx:{bgcolor:"#f5f5f5"},children:"Sale/Item"}),(0,P.jsx)(f.A,{align:"center",sx:{bgcolor:"#f5f5f5"},children:"Total Selling"}),(0,P.jsx)(f.A,{})]})}),(0,P.jsx)(v.A,{children:s.map((e,t)=>(0,P.jsxs)(A.A,{children:[(0,P.jsx)(f.A,{children:e.product_name}),(0,P.jsx)(f.A,{align:"center",children:(0,P.jsx)(j.A,{label:e.quantity_ordered,size:"small"})}),(0,P.jsx)(f.A,{align:"center",children:(0,P.jsx)(j.A,{label:e.quantity_already_received,size:"small",color:e.quantity_already_received>0?"success":"default"})}),(0,P.jsx)(f.A,{align:"center",children:(0,P.jsx)(j.A,{label:e.quantity_remaining,size:"small",color:e.quantity_remaining>0?"warning":"success"})}),(0,P.jsx)(f.A,{align:"center",sx:{bgcolor:"#f5faff"},children:(0,P.jsx)(u.A,{type:"number",size:"small",placeholder:"Boxes",value:e.boxes_received,onChange:e=>C(t,"boxes_received",e.target.value),inputProps:{min:0,style:{width:"60px",textAlign:"center"}},disabled:0===e.quantity_remaining})}),(0,P.jsx)(f.A,{align:"center",sx:{bgcolor:"#f5faff"},children:(0,P.jsx)(u.A,{type:"number",size:"small",placeholder:"/Box",value:e.items_per_box,onChange:e=>C(t,"items_per_box",e.target.value),inputProps:{min:1,style:{width:"50px",textAlign:"center"}},disabled:0===e.quantity_remaining})}),(0,P.jsx)(f.A,{align:"center",sx:{bgcolor:"#f5faff"},children:(0,P.jsx)(u.A,{type:"number",size:"small",placeholder:"Total",value:e.total_cost,onChange:e=>R(t,"total_cost",e.target.value),inputProps:{min:0,step:.01,style:{width:"80px",textAlign:"center"}}})}),(0,P.jsx)(f.A,{align:"center",sx:{bgcolor:"#f5faff"},children:(0,P.jsx)(u.A,{type:"number",size:"small",value:e.selling_price_per_box,onChange:e=>R(t,"selling_price_per_box",e.target.value),placeholder:"MRP",inputProps:{min:0,step:.01,style:{width:"80px",textAlign:"center"}}})}),(0,P.jsx)(f.A,{align:"center",sx:{bgcolor:"#f5f5f5"},children:(0,P.jsx)(l.A,{variant:"body2",fontWeight:600,children:e.quantity_to_receive})}),(0,P.jsx)(f.A,{align:"center",sx:{bgcolor:"#f5f5f5"},children:(0,P.jsx)(l.A,{variant:"body2",children:e.cost_per_box?parseFloat(e.cost_per_box).toFixed(2):"-"})}),(0,P.jsx)(f.A,{align:"center",sx:{bgcolor:"#f5f5f5"},children:(0,P.jsx)(l.A,{variant:"body2",children:e.unit_price?parseFloat(e.unit_price).toFixed(2):"-"})}),(0,P.jsx)(f.A,{align:"center",sx:{bgcolor:"#f5f5f5"},children:(0,P.jsx)(l.A,{variant:"body2",children:e.selling_price?parseFloat(e.selling_price).toFixed(2):"-"})}),(0,P.jsx)(f.A,{align:"center",sx:{bgcolor:"#f5f5f5"},children:(0,P.jsx)(l.A,{variant:"body2",fontWeight:600,color:"success.main",children:e.total_selling_price?parseFloat(e.total_selling_price).toFixed(2):"-"})}),(0,P.jsx)(f.A,{children:e.quantity_remaining>0&&(0,P.jsx)(d.A,{size:"small",onClick:()=>(e=>{const t=[...s];t[e].quantity_to_receive=t[e].quantity_remaining,c(t)})(t),children:"All"})})]},t))})]})})}),(0,P.jsx)(M.Ay,{item:!0,xs:12,children:(0,P.jsx)(a.A,{bgcolor:"primary.main",color:"white",p:2,borderRadius:1,children:(0,P.jsxs)(M.Ay,{container:!0,children:[(0,P.jsx)(M.Ay,{item:!0,xs:6,children:(0,P.jsxs)(l.A,{variant:"h6",children:["Total Items: ",q]})}),(0,P.jsx)(M.Ay,{item:!0,xs:6,children:(0,P.jsxs)(l.A,{variant:"h6",align:"right",children:["Total Cost: Rs ",z.toFixed(2)]})})]})})}),(0,P.jsx)(M.Ay,{item:!0,xs:12,children:(0,P.jsx)(u.A,{fullWidth:!0,multiline:!0,rows:2,label:"Delivery Notes",value:h,onChange:e=>y(e.target.value),placeholder:"Optional notes about this delivery (condition, packaging, etc.)"})})]})}),(0,P.jsxs)(V.A,{children:[(0,P.jsx)(d.A,{onClick:n,children:"Cancel"}),(0,P.jsx)(d.A,{variant:"contained",startIcon:(0,P.jsx)(X.A,{}),onClick:async()=>{const e=s.filter(e=>e.quantity_to_receive>0);if(0===e.length)return void W.oR.error("Please enter quantities to receive");if(e.filter(e=>e.unit_price<=0||e.selling_price<=0).length>0)W.oR.error("Please enter both purchasing and selling prices for all items being received");else{w(!0);try{const{data:{session:t}}=await N.N.auth.getSession();if(!t)throw new Error("Not authenticated");for(const n of e){const{data:e,error:r}=await N.N.from("stock_receipts").insert([{product_id:n.product_id,quantity:n.quantity_to_receive,received_date:p,notes:h,purchase_order_id:i.id,organization_id:t.user.id}]).select().single();if(r)throw r;const{data:o,error:s}=await N.N.from("products").select("stock").eq("id",n.product_id).single();if(s)throw s;const a=((null===o||void 0===o?void 0:o.stock)||0)+parseInt(n.quantity_to_receive),{error:l}=await N.N.from("products").update({stock:a,cost_price:n.unit_price,price:n.selling_price,items_per_box:n.items_per_box,price_per_box:n.selling_price_per_box}).eq("id",n.product_id);if(l)throw l;const{error:d}=await N.N.from("purchase_order_items").update({quantity_received:n.quantity_already_received+n.quantity_to_receive,unit_price:n.unit_price}).eq("id",n.po_item_id);if(d)throw d;await N.N.from("po_receiving_history").insert([{purchase_order_id:i.id,po_item_id:n.po_item_id,quantity_received:n.quantity_to_receive,received_date:p,received_by:t.user.id,stock_receipt_id:e.id,notes:h,boxes_received:n.boxes_received?parseInt(n.boxes_received):null}])}s.every(e=>e.quantity_already_received+e.quantity_to_receive>=e.quantity_ordered)?await N.N.from("purchase_orders").update({status:"received"}).eq("id",i.id):await N.N.from("purchase_orders").update({status:"partially_received"}).eq("id",i.id),W.oR.success("Stock received successfully!"),n()}catch(t){console.error("Error receiving stock:",t),W.oR.error("Failed to receive stock: "+t.message)}finally{w(!1)}}},disabled:b||0===q,children:"Receive Stock"})]})]})}var $=n(37762),ee=n(64857);const te=async(e,t,n)=>{try{var r,i;const o=new $.Ay,s=(null===n||void 0===n?void 0:n.store_name)||"Medical Store",a=(null===e||void 0===e?void 0:e.po_number)||"DRAFT",l=null!==e&&void 0!==e&&e.order_date?new Date(e.order_date).toLocaleDateString():(new Date).toLocaleDateString(),d=(null===e||void 0===e||null===(r=e.suppliers)||void 0===r?void 0:r.name)||"N/A",c=(null===e||void 0===e||null===(i=e.suppliers)||void 0===i?void 0:i.phone)||"",p=Array.isArray(t)?t:[];o.setFontSize(20),o.setFont(void 0,"bold"),o.text(s,105,20,{align:"center"}),o.setFontSize(10),o.setFont(void 0,"normal");let u=28;null!==n&&void 0!==n&&n.address&&(o.text(n.address,105,u,{align:"center"}),u+=5),null!==n&&void 0!==n&&n.phone&&(o.text("Phone: ".concat(n.phone),105,u,{align:"center"}),u+=5),null!==n&&void 0!==n&&n.owner_name&&(o.text("Owner: ".concat(n.owner_name),105,u,{align:"center"}),u+=5),o.setLineWidth(.5),o.line(14,u+3,196,u+3),o.setFontSize(16),o.setFont(void 0,"bold"),o.text("PURCHASE ORDER",105,u+12,{align:"center"});const x=u+22;o.setFontSize(11),o.setFont(void 0,"bold"),o.text("PO Details:",14,x),o.setFont(void 0,"normal"),o.text("PO Number: ".concat(a),14,x+7),o.text("Order Date: ".concat(l),14,x+14),o.setFont(void 0,"bold"),o.text("Supplier:",120,x),o.setFont(void 0,"normal"),o.text(d,120,x+7),c&&o.text("Phone: ".concat(c),120,x+14);const h=["#","Product","Quantity (Boxes)"],m=p.map((e,t)=>{var n;let r="N/A";e.product_name?r=e.product_name:null!==(n=e.products)&&void 0!==n&&n.name&&(r=e.products.name);const i=e.quantity_ordered||0;return[(t+1).toString(),r,i.toString()]});(0,ee.Ay)(o,{head:[h],body:m,startY:x+25,theme:"striped",headStyles:{fillColor:[41,128,185],fontStyle:"bold",fontSize:11},styles:{fontSize:10},columnStyles:{0:{cellWidth:15},1:{cellWidth:125},2:{cellWidth:40,halign:"center"}}});let _=o.lastAutoTable&&o.lastAutoTable.finalY||x+30+10;if(null!==e&&void 0!==e&&e.notes){o.setFontSize(10),o.setFont(void 0,"bold"),o.text("Notes:",14,_),o.setFont(void 0,"normal");const t=o.splitTextToSize(e.notes,180);o.text(t,14,_+6),_+=6+5*t.length}_+=15,_>250&&(o.addPage(),_=20),o.setFontSize(10),o.setFont(void 0,"normal"),o.text("Prepared By:",14,_),o.line(14,_+15,80,_+15),o.setFontSize(9),o.text("Signature & Date",30,_+20),o.setFontSize(10),o.text("Approved By:",120,_),o.line(120,_+15,186,_+15),o.setFontSize(9),o.text("Signature & Date",135,_+20);const g=o.internal.pageSize.height;o.setFontSize(9),o.setFont(void 0,"italic"),o.setTextColor(100,100,100);const A=g-20;return null!==n&&void 0!==n&&n.footer_text?o.text(n.footer_text,105,A,{align:"center"}):o.text("Thank you for your service!",105,A,{align:"center"}),o.setFontSize(8),o.text("Page 1",105,A+10,{align:"center"}),o.output("blob")}catch(o){console.error("PDF Generation Error:",o);const e=new $.Ay;return e.text("Error generating PDF receipt.",10,10),e.text(o.message,10,20),e.output("blob")}};var ne=n(88458);function re(e){var t,n;let{open:i,onClose:o,purchaseOrder:s,onRefresh:c}=e;const[p,u]=(0,r.useState)(null),[x,h]=(0,r.useState)([]),[w,S]=(0,r.useState)([]),[C,q]=(0,r.useState)(!1),[z,D]=(0,r.useState)(!1);(0,r.useEffect)(()=>{i&&s&&k()},[i,s]);const k=async()=>{if(s)try{const{data:e,error:t}=await N.N.from("purchase_orders").select("\n                    *,\n                    suppliers(name, phone, supplier_contacts(*))\n                ").eq("id",s.id).single();if(t)throw t;u(e);const{data:n,error:r}=await N.N.from("purchase_order_items").select("*, products(name)").eq("purchase_order_id",s.id);if(r)throw r;h(n||[]);const{data:i,error:o}=await N.N.from("po_receiving_history").select("*").eq("purchase_order_id",s.id).order("created_at",{ascending:!1});if(o)throw o;S(i||[])}catch(e){console.error("Error fetching PO details:",e),W.oR.error("Failed to load PO details")}};if(!p)return null;return(0,P.jsxs)(P.Fragment,{children:[(0,P.jsxs)(T.A,{open:i,onClose:o,maxWidth:"md",fullWidth:!0,children:[(0,P.jsx)(U.A,{children:(0,P.jsxs)(a.A,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[(0,P.jsxs)(l.A,{variant:"h6",children:["Purchase Order: ",p.po_number]}),(0,P.jsx)(b.A,{onClick:o,children:(0,P.jsx)(Y.A,{})})]})}),(0,P.jsx)(B.A,{children:(0,P.jsxs)(M.Ay,{container:!0,spacing:2,children:[(0,P.jsx)(M.Ay,{item:!0,xs:12,children:(0,P.jsxs)(a.A,{display:"flex",gap:1,flexWrap:"wrap",children:[(0,P.jsx)(j.A,{label:(F=p.status,{draft:"Draft",sent:"Sent",partially_received:"Receiving",received:"Completed"}[F]||F),color:(e=>({draft:"default",sent:"primary",partially_received:"secondary",received:"success"}[e]||"default"))(p.status)}),(0,P.jsx)(j.A,{label:"Order: ".concat(new Date(p.order_date).toLocaleDateString()),variant:"outlined"}),p.expected_delivery_date&&(0,P.jsx)(j.A,{label:"Expected: ".concat(new Date(p.expected_delivery_date).toLocaleDateString()),variant:"outlined"})]})}),(0,P.jsxs)(M.Ay,{item:!0,xs:12,children:[(0,P.jsx)(l.A,{variant:"subtitle2",color:"text.secondary",children:"Supplier"}),(0,P.jsx)(l.A,{variant:"h6",children:null===(t=p.suppliers)||void 0===t?void 0:t.name}),(null===(n=p.suppliers)||void 0===n?void 0:n.phone)&&(0,P.jsxs)(l.A,{variant:"body2",color:"text.secondary",children:["Phone: ",p.suppliers.phone]})]}),(0,P.jsxs)(M.Ay,{item:!0,xs:12,children:[(0,P.jsx)(H.A,{sx:{my:1}}),(0,P.jsx)(l.A,{variant:"h6",gutterBottom:!0,children:"Items"}),(0,P.jsx)(m.A,{children:(0,P.jsxs)(_.A,{size:"small",children:[(0,P.jsx)(g.A,{children:(0,P.jsxs)(A.A,{children:[(0,P.jsx)(f.A,{children:"Product"}),(0,P.jsx)(f.A,{align:"center",children:"Ordered"}),(0,P.jsx)(f.A,{align:"center",children:"Received"}),"draft"!==p.status&&(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)(f.A,{align:"right",children:"Unit Price"}),(0,P.jsx)(f.A,{align:"right",children:"Total"})]})]})}),(0,P.jsx)(v.A,{children:x.map(e=>{var t;return(0,P.jsxs)(A.A,{children:[(0,P.jsx)(f.A,{children:null===(t=e.products)||void 0===t?void 0:t.name}),(0,P.jsx)(f.A,{align:"center",children:(0,P.jsx)(j.A,{label:e.boxes_ordered?"".concat(e.boxes_ordered," Boxes (").concat(e.quantity_ordered,")"):e.quantity_ordered,size:"small"})}),(0,P.jsx)(f.A,{align:"center",children:(0,P.jsx)(j.A,{label:e.quantity_received,size:"small",color:e.quantity_received>=e.quantity_ordered?"success":"default"})}),"draft"!==p.status&&(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)(f.A,{align:"right",children:e.unit_price>0?"Rs ".concat((0,L.vv)(e.unit_price,"")):"\u2014"}),(0,P.jsx)(f.A,{align:"right",children:e.unit_price>0?"Rs ".concat((0,L.vv)(e.quantity_ordered*e.unit_price,"")):"\u2014"})]})]},e.id)})})]})})]}),w.length>0&&(0,P.jsxs)(M.Ay,{item:!0,xs:12,children:[(0,P.jsx)(H.A,{sx:{my:1}}),(0,P.jsx)(l.A,{variant:"h6",gutterBottom:!0,children:"Receiving History"}),w.map(e=>(0,P.jsx)(a.A,{sx:{mb:1,p:1,bgcolor:"grey.50",borderRadius:1},children:(0,P.jsxs)(l.A,{variant:"body2",children:[(0,P.jsxs)("strong",{children:[new Date(e.received_date).toLocaleDateString(),":"]})," ","Received ",e.quantity_received," units",e.notes&&" - ".concat(e.notes)]})},e.id))]}),p.notes&&(0,P.jsxs)(M.Ay,{item:!0,xs:12,children:[(0,P.jsx)(l.A,{variant:"subtitle2",color:"text.secondary",children:"Notes"}),(0,P.jsx)(l.A,{variant:"body2",children:p.notes})]})]})}),(0,P.jsxs)(V.A,{sx:{flexWrap:"wrap",gap:1,p:2},children:[(0,P.jsx)(a.A,{flex:1,display:"flex",gap:1,children:(0,P.jsx)(y.A,{title:"Download PDF",children:(0,P.jsx)(b.A,{color:"primary",onClick:async()=>{try{const{data:{session:e}}=await N.N.auth.getSession(),{data:t}=await N.N.from("settings").select("*").eq("organization_id",e.user.id).single(),n=await te(p,x,t),r=URL.createObjectURL(n),i=document.createElement("a");i.href=r,i.download="".concat(p.po_number,".pdf"),i.click(),URL.revokeObjectURL(r),W.oR.success("PDF downloaded!")}catch(e){console.error("Error generating PDF:",e),W.oR.error("Failed to generate PDF")}},children:(0,P.jsx)(G.A,{})})})}),(0,P.jsxs)(a.A,{display:"flex",gap:1,flexWrap:"wrap",children:["draft"===p.status&&(0,P.jsx)(d.A,{startIcon:(0,P.jsx)(R,{}),variant:"contained",onClick:async()=>{D(!0);try{var e,t,n;const{data:{session:i}}=await N.N.auth.getSession(),{data:o}=await N.N.from("settings").select("*").eq("organization_id",i.user.id).single();try{const e=await te(p,x,o),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="".concat(p.po_number,".pdf"),n.click(),URL.revokeObjectURL(t),W.oR.info("PDF downloaded! Please attach it to the WhatsApp chat.")}catch(r){console.error("PDF Error:",r),W.oR.warning("Could not generate PDF, but opening WhatsApp...")}const{error:a}=await N.N.from("purchase_orders").update({status:"sent",sent_at:(new Date).toISOString()}).eq("id",s.id);if(a)throw a;const l=null===(e=p.suppliers)||void 0===e||null===(t=e.supplier_contacts)||void 0===t?void 0:t.find(e=>e.is_primary),d=(null===l||void 0===l?void 0:l.phone)||(null===(n=p.suppliers)||void 0===n?void 0:n.phone);if(d){const e="Hello! Please find the Purchase Order ".concat(p.po_number,". We need these items as soon as possible. Thank you!");setTimeout(()=>(0,ne.JT)(d,e),1e3)}else W.oR.warning("No phone number found for supplier");W.oR.success("PO marked as sent!"),c(),k()}catch(i){console.error("Error sending PO:",i),W.oR.error("Failed to send PO")}finally{D(!1)}},disabled:z,children:"Send to Supplier"}),("sent"===p.status||"partially_received"===p.status)&&(0,P.jsx)(d.A,{startIcon:(0,P.jsx)(O.A,{}),variant:"contained",color:"primary",onClick:()=>{q(!0)},children:"Receive Stock"}),(0,P.jsx)(d.A,{onClick:o,children:"Close"})]})]})]}),(0,P.jsx)(Z,{open:C,onClose:()=>{q(!1),k(),c()},purchaseOrder:p,poItems:x})]});var F}var ie=n(63336),oe=n(25298),se=n(30513);const ae=(0,C.A)((0,P.jsx)("path",{d:"M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92"}),"Share"),le=(e,t,n)=>{try{var r,i;const o=(null===n||void 0===n?void 0:n.store_name)||"Medical Store",s=(null===n||void 0===n||n.currency_symbol,(null===e||void 0===e?void 0:e.po_number)||"DRAFT"),a=null!==e&&void 0!==e&&e.order_date?new Date(e.order_date).toLocaleDateString():(new Date).toLocaleDateString(),l=(null===e||void 0===e||null===(r=e.suppliers)||void 0===r?void 0:r.name)||"N/A",d=(null===e||void 0===e||null===(i=e.suppliers)||void 0===i?void 0:i.phone)||"",c='\n<!DOCTYPE html>\n<html>\n<head>\n    <meta charset="UTF-8">\n    <title>PO #'.concat(s,'</title>\n    <style>\n        @media print {\n            @page {\n                size: 80mm auto;\n                margin: 5mm;\n            }\n            body {\n                margin: 0;\n                padding: 0;\n            }\n        }\n        \n        body {\n            font-family: \'Courier New\', monospace;\n            width: 80mm;\n            margin: 0 auto;\n            padding: 10px;\n            font-size: 12px;\n        }\n        \n        .header {\n            text-align: center;\n            margin-bottom: 15px;\n            border-bottom: 2px dashed #000;\n            padding-bottom: 10px;\n        }\n       \n        .store-name {\n            font-size: 18px;\n            font-weight: bold;\n            margin-bottom: 5px;\n        }\n        \n        .receipt-title {\n            font-size: 14px;\n            font-weight: bold;\n            margin-bottom: 5px;\n        }\n        \n        .info-row {\n            display: flex;\n            justify-content: space-between;\n            font-size: 11px;\n            margin-bottom: 2px;\n        }\n        \n        .items-table {\n            width: 100%;\n            margin: 10px 0;\n            border-collapse: collapse;\n        }\n        \n        .items-table th {\n            text-align: left;\n            border-bottom: 1px solid #000;\n            padding: 5px 2px;\n            font-size: 10px;\n        }\n        \n        .items-table td {\n            padding: 5px 2px;\n            font-size: 10px;\n            vertical-align: top;\n        }\n        \n        .item-name {\n            max-width: 40mm;\n            word-wrap: break-word;\n        }\n        \n        .text-center {\n            text-align: center;\n        }\n        \n        .text-right {\n            text-align: right;\n        }\n        \n        .footer {\n            text-align: center;\n            margin-top: 15px;\n            padding-top: 10px;\n            border-top: 2px dashed #000;\n            font-size: 10px;\n            color: #555;\n        }\n        \n        .branding {\n            margin-top: 10px;\n            font-size: 9px;\n            color: #888;\n            font-style: italic;\n        }\n\n        .notes {\n            margin-top: 10px;\n            border-top: 1px dashed #000;\n            padding-top: 5px;\n            font-size: 11px;\n        }\n    </style>\n</head>\n<body>\n    <div class="header">\n        <div class="store-name">').concat(o,"</div>\n        ").concat(null!==n&&void 0!==n&&n.address?'<div style="font-size: 10px;">'.concat(n.address,"</div>"):"","\n        ").concat(null!==n&&void 0!==n&&n.phone?'<div style="font-size: 10px;">Phone: '.concat(n.phone,"</div>"):"",'\n        <div class="receipt-title" style="margin-top: 10px;">PURCHASE ORDER</div>\n    </div>\n\n    <div class="info-row">\n        <span>PO #:</span>\n        <span>').concat(s,'</span>\n    </div>\n    <div class="info-row">\n        <span>Date:</span>\n        <span>').concat(a,'</span>\n    </div>\n    <div class="info-row">\n        <span>Supplier:</span>\n        <span>').concat(l,"</span>\n    </div>\n    ").concat(d?'\n    <div class="info-row">\n        <span>Supplier Ph:</span>\n        <span>'.concat(d,"</span>\n    </div>"):"",'\n    \n    <table class="items-table">\n        <thead>\n            <tr>\n                <th>Item</th>\n                <th class="text-right">Qty (Boxes)</th>\n            </tr>\n        </thead>\n        <tbody>\n            ').concat(t.map(e=>{var t;let n="N/A";e.product_name?n=e.product_name:null!==(t=e.products)&&void 0!==t&&t.name&&(n=e.products.name);const r=e.quantity_ordered||0;return'\n                <tr>\n                    <td class="item-name">'.concat(n,'</td>\n                    <td class="text-right">').concat(r,"</td>\n                </tr>\n                ")}).join(""),"\n        </tbody>\n    </table>\n    \n    ").concat(e.notes?'\n    <div class="notes">\n        <strong>Notes:</strong><br/>\n        '.concat(e.notes,"\n    </div>\n    "):"",'\n    \n    <div class="footer">\n        ').concat((null===n||void 0===n?void 0:n.footer_text)||"Thank you for your service!",'\n        <div class="branding">\n            \n        </div>\n    </div>\n    \n    <script>\n        // Auto-close window after printing or canceling\n        window.onafterprint = function() {\n            window.close();\n        };\n        \n        // Trigger print dialog immediately\n        window.onload = function() {\n            window.print();\n        };\n    <\/script>\n</body>\n</html>\n        '),p=window.open("","_blank","width=400,height=600");return p?(p.document.write(c),p.document.close(),!0):(console.error("Could not open print window. Popup blocked?"),!1)}catch(o){return console.error("PO printing failed:",o),!1}};var de=n(65239),ce=n.n(de);function pe(e){let{open:t,onClose:n,purchaseOrder:r,poItems:s,supplier:c,settings:p}=e;const u=(0,i.A)(),x=(0,o.A)(u.breakpoints.down("sm"));if(!r||!s||!c)return null;return(0,P.jsxs)(T.A,{open:t,onClose:n,maxWidth:"sm",fullWidth:!0,children:[(0,P.jsx)(U.A,{children:(0,P.jsxs)(a.A,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[(0,P.jsxs)(a.A,{display:"flex",alignItems:"center",gap:1,children:[(0,P.jsx)(q.A,{color:"success"}),(0,P.jsx)(l.A,{variant:"h6",children:"Purchase Order Created!"})]}),(0,P.jsx)(b.A,{onClick:n,size:"small",children:(0,P.jsx)(Y.A,{})})]})}),(0,P.jsx)(B.A,{children:(0,P.jsxs)(ie.A,{id:"po-receipt-content",elevation:3,sx:{p:3,bgcolor:"grey.50",border:"1px solid",borderColor:"grey.300"},children:[(0,P.jsxs)(a.A,{textAlign:"center",mb:2,children:[(0,P.jsx)(l.A,{variant:"h5",fontWeight:700,color:"primary",gutterBottom:!0,children:(null===p||void 0===p?void 0:p.store_name)||"Medical Store"}),(null===p||void 0===p?void 0:p.address)&&(0,P.jsx)(l.A,{variant:"body2",color:"text.secondary",children:p.address}),(null===p||void 0===p?void 0:p.phone)&&(0,P.jsxs)(l.A,{variant:"body2",color:"text.secondary",children:["Phone: ",p.phone]}),(null===p||void 0===p?void 0:p.owner_name)&&(0,P.jsxs)(l.A,{variant:"body2",color:"text.secondary",children:["Owner: ",p.owner_name]})]}),(0,P.jsx)(H.A,{sx:{my:2,borderColor:"primary.main",borderWidth:1}}),(0,P.jsxs)(a.A,{textAlign:"center",my:2,children:[(0,P.jsx)(l.A,{variant:"h6",fontWeight:700,color:"text.primary",children:"PURCHASE ORDER"}),(0,P.jsx)(l.A,{variant:"h4",fontWeight:700,color:"primary",mt:1,children:r.po_number})]}),(0,P.jsx)(H.A,{sx:{my:2}}),(0,P.jsx)(_.A,{size:"small",children:(0,P.jsxs)(v.A,{children:[(0,P.jsxs)(A.A,{children:[(0,P.jsx)(f.A,{sx:{fontWeight:600,border:"none",py:.5},children:"Date:"}),(0,P.jsx)(f.A,{sx:{border:"none",py:.5},children:new Date(r.order_date).toLocaleDateString()})]}),(0,P.jsxs)(A.A,{children:[(0,P.jsx)(f.A,{sx:{fontWeight:600,border:"none",py:.5},children:"Supplier:"}),(0,P.jsx)(f.A,{sx:{border:"none",py:.5},children:null===c||void 0===c?void 0:c.name})]}),(null===c||void 0===c?void 0:c.phone)&&(0,P.jsxs)(A.A,{children:[(0,P.jsx)(f.A,{sx:{fontWeight:600,border:"none",py:.5},children:"Supplier Phone:"}),(0,P.jsx)(f.A,{sx:{border:"none",py:.5},children:c.phone})]})]})}),(0,P.jsx)(H.A,{sx:{my:2}}),(0,P.jsxs)(a.A,{mb:2,children:[(0,P.jsx)(l.A,{variant:"subtitle2",fontWeight:700,color:"text.secondary",gutterBottom:!0,children:"Items Ordered:"}),(0,P.jsx)(m.A,{sx:{bgcolor:"white",borderRadius:1,border:"1px solid",borderColor:"grey.300"},children:(0,P.jsxs)(_.A,{size:"small",children:[(0,P.jsx)(g.A,{children:(0,P.jsxs)(A.A,{sx:{bgcolor:"grey.100"},children:[(0,P.jsx)(f.A,{sx:{fontWeight:700},children:"Product"}),(0,P.jsx)(f.A,{align:"right",sx:{fontWeight:700},children:"Quantity"})]})}),(0,P.jsx)(v.A,{children:s.map((e,t)=>(0,P.jsxs)(A.A,{hover:!0,children:[(0,P.jsx)(f.A,{children:e.product_name}),(0,P.jsx)(f.A,{align:"right",children:(0,P.jsx)("strong",{children:e.boxes_ordered?"".concat(e.boxes_ordered," Boxes (").concat(e.quantity_ordered," items)"):"".concat(e.quantity_ordered," items")})})]},t))})]})})]}),r.notes&&(0,P.jsxs)(a.A,{mb:2,children:[(0,P.jsx)(l.A,{variant:"subtitle2",fontWeight:700,color:"text.secondary",gutterBottom:!0,children:"Notes:"}),(0,P.jsx)(a.A,{sx:{bgcolor:"info.lighter",p:1.5,borderRadius:1,border:"1px dashed",borderColor:"info.main"},children:(0,P.jsx)(l.A,{variant:"body2",children:r.notes})})]}),(0,P.jsx)(H.A,{sx:{my:2}}),(0,P.jsxs)(a.A,{mt:3,children:[(0,P.jsx)(l.A,{variant:"caption",color:"text.secondary",display:"block",gutterBottom:!0,children:"Digital Signature:"}),(0,P.jsxs)(a.A,{sx:{border:"2px dashed",borderColor:"grey.400",borderRadius:1,p:2,textAlign:"center",bgcolor:"grey.100"},children:[(0,P.jsxs)(l.A,{variant:"body2",color:"text.secondary",fontStyle:"italic",children:["Authorized by: ",(null===p||void 0===p?void 0:p.owner_name)||"Store Owner"]}),(0,P.jsx)(l.A,{variant:"caption",color:"text.secondary",children:(new Date).toLocaleString()})]})]}),(null===p||void 0===p?void 0:p.footer_text)&&(0,P.jsx)(a.A,{mt:2,textAlign:"center",children:(0,P.jsx)(l.A,{variant:"caption",color:"text.secondary",fontStyle:"italic",children:p.footer_text})}),(0,P.jsxs)(a.A,{mt:2,textAlign:"center",pt:2,borderTop:"1px dashed #ccc",children:[(0,P.jsxs)(l.A,{variant:"caption",color:"text.secondary",fontStyle:"italic",children:["Receipt designed and generated by ",(0,P.jsx)("strong",{children:"MedixFlow"})]}),(0,P.jsx)(l.A,{variant:"caption",display:"block",color:"text.secondary",children:"Contact: +923089020131"})]})]})}),(0,P.jsxs)(V.A,{sx:{p:2,flexDirection:"column",gap:1,bgcolor:"grey.50"},children:[(0,P.jsxs)(a.A,{display:"flex",gap:1,width:"100%",flexWrap:"wrap",justifyContent:"center",children:[(0,P.jsx)(d.A,{variant:"contained",startIcon:(0,P.jsx)(oe.A,{}),onClick:async()=>{var e,t;const n=(null===c||void 0===c?void 0:c.phone)||(null===c||void 0===c||null===(e=c.supplier_contacts)||void 0===e||null===(t=e.find(e=>e.is_primary))||void 0===t?void 0:t.phone);if(!n)return void W.oR.error("No phone number found for supplier");const i=W.oR.loading("Generating receipt image...");try{const e=await(async()=>{try{const e=document.getElementById("po-receipt-content");if(!e)return null;const t=await ce()(e,{scale:2,backgroundColor:"#ffffff",logging:!1});return new Promise(e=>{t.toBlob(t=>{e(t)},"image/png")})}catch(e){return console.error("Error generating image:",e),null}})();if(!e)throw new Error("Failed to generate image");const t=new File([e],"PO-".concat(r.po_number,".png"),{type:"image/png"});if(navigator.share&&navigator.canShare&&navigator.canShare({files:[t]}))W.oR.update(i,{render:"Opening share menu...",type:"info",isLoading:!1,autoClose:2e3}),await navigator.share({title:"PO ".concat(r.po_number),text:"Purchase Order: ".concat(r.po_number,"\n\nPlease find the order details in the attached image.\n\nThank you!"),files:[t]}),W.oR.success("Shared successfully!");else{const t=URL.createObjectURL(e),o=document.createElement("a");o.href=t,o.download="PO-".concat(r.po_number,".png"),o.click(),URL.revokeObjectURL(t),W.oR.update(i,{render:"Image downloaded! Opening WhatsApp - please attach it.",type:"success",isLoading:!1,autoClose:5e3});const s="Purchase Order: ".concat(r.po_number,"\n\nPlease find the order details in the downloaded image file.\n\nThank you!");setTimeout(()=>{(0,ne.JT)(n,s)},1e3)}}catch(o){if(console.error("Error handling WhatsApp share:",o),"AbortError"===o.name)return void W.oR.dismiss(i);W.oR.update(i,{render:"Failed to share. Opening WhatsApp with text only.",type:"warning",isLoading:!1,autoClose:3e3});const e="Purchase Order: ".concat(r.po_number,"\n\nItems:\n").concat(s.map(e=>"- ".concat(e.product_name," x").concat(e.quantity_ordered)).join("\n"),"\n\nPlease confirm availability.");(0,ne.JT)(n,e)}},fullWidth:x,sx:{bgcolor:"#25D366","&:hover":{bgcolor:"#1fb855"}},children:"Send via WhatsApp"}),(0,P.jsx)(d.A,{variant:"outlined",startIcon:(0,P.jsx)(G.A,{}),onClick:async()=>{try{const e=await te(r,s,p),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="".concat(r.po_number,".pdf"),n.click(),URL.revokeObjectURL(t),W.oR.success("PDF downloaded!")}catch(e){console.error("Error generating PDF:",e),W.oR.error("Failed to generate PDF: "+e.message)}},fullWidth:x,children:"Download PDF"})]}),(0,P.jsxs)(a.A,{display:"flex",gap:1,width:"100%",flexWrap:"wrap",justifyContent:"center",children:[(0,P.jsx)(d.A,{variant:"outlined",startIcon:(0,P.jsx)(se.A,{}),onClick:()=>{le(r,s,p)||W.oR.error("Failed to open print window. Please allow popups.")},fullWidth:x,children:"Print"}),(0,P.jsx)(d.A,{variant:"outlined",startIcon:(0,P.jsx)(ae,{}),onClick:async()=>{try{const e="Purchase Order: ".concat(r.po_number,"\n\nSupplier: ").concat(null===c||void 0===c?void 0:c.name,"\nDate: ").concat(new Date(r.order_date).toLocaleDateString(),"\n\nItems:\n").concat(s.map(e=>"- ".concat(e.product_name," x").concat(e.quantity_ordered)).join("\n"));navigator.share?await navigator.share({title:"PO ".concat(r.po_number),text:e}):(await navigator.clipboard.writeText(e),W.oR.success("Order details copied to clipboard!"))}catch(e){console.error("Error sharing:",e)}},fullWidth:x,children:"Share"})]}),(0,P.jsx)(d.A,{onClick:n,fullWidth:!0,variant:"text",sx:{mt:1},children:"Close"})]})]})}var ue=n(11737),xe=n(90990),he=n(8649);function me(){const{settings:e}=(0,ue.A)(),{toggleHelp:t}=(0,he.d)(),n=(0,i.A)(),C=(0,o.A)(n.breakpoints.down("sm")),[E,T]=(0,r.useState)([]),[U,B]=(0,r.useState)([]),[M,H]=(0,r.useState)(!0),[K,V]=(0,r.useState)(""),[J,Y]=(0,r.useState)("all"),[G,X]=(0,r.useState)("all"),[Z,$]=(0,r.useState)(0),[ee,te]=(0,r.useState)(25),[ne,ie]=(0,r.useState)(0),[oe,se]=(0,r.useState)(!1),[ae,le]=(0,r.useState)(!1),[de,ce]=(0,r.useState)(null),[me,_e]=(0,r.useState)(!1),[ge,Ae]=(0,r.useState)({po:null,items:[],supplier:null}),fe=(0,r.useRef)(null);(0,xe.A)({"Alt+n":()=>we(),"Alt+f":()=>{var e;return null===(e=fe.current)||void 0===e?void 0:e.focus()}},"Purchase Orders Page"),(0,r.useEffect)(()=>{ve(),je()},[]),(0,r.useEffect)(()=>{const e=setTimeout(()=>{ve()},500);return()=>clearTimeout(e)},[K,J,G,Z,ee]),(0,r.useEffect)(()=>{je()},[]);const ve=async()=>{H(!0);try{const{data:{session:e}}=await N.N.auth.getSession();if(!e)return;let t=N.N.from("purchase_orders").select("\n                    *,\n                    suppliers(name, phone, supplier_contacts(*))\n                ",{count:"exact"}).eq("organization_id",e.user.id).is("deleted_at",null).order("created_at",{ascending:!1});K&&(t=t.ilike("po_number","%".concat(K,"%"))),"all"!==J&&(t=t.eq("status",J)),"all"!==G&&(t=t.eq("supplier_id",G));const n=Z*ee,r=n+ee-1,{data:i,count:o,error:s}=await t.range(n,r);if(s)throw s;T(i||[]),ie(o||0)}catch(e){console.error("Error fetching POs:",e),W.oR.error("Failed to load purchase orders")}finally{H(!1)}},je=async()=>{const{data:{session:e}}=await N.N.auth.getSession();if(!e)return;const{data:t,error:n}=await N.N.from("suppliers").select("*, supplier_contacts(*)").eq("organization_id",e.user.id).is("deleted_at",null).order("name");n?console.error("Error fetching suppliers:",n):B(t||[])},ye=e=>({draft:"default",sent:"primary",partially_received:"secondary",received:"success"}[e]||"default"),be=e=>({draft:"Draft",sent:"Sent",partially_received:"Receiving",received:"Completed"}[e]||e),we=()=>{ce(null),se(!0)};return(0,P.jsxs)(s.A,{maxWidth:"xl",children:[(0,P.jsxs)(a.A,{display:"flex",flexDirection:C?"column":"row",justifyContent:"space-between",alignItems:C?"flex-start":"center",gap:2,mb:3,children:[(0,P.jsx)(l.A,{variant:"h4",fontWeight:700,color:"primary",children:"Purchase Orders"}),(0,P.jsxs)(a.A,{display:"flex",gap:1,children:[(0,P.jsx)(d.A,{variant:"outlined",startIcon:(0,P.jsx)(z.A,{}),onClick:t,size:C?"small":"medium",children:"Shortcuts"}),(0,P.jsx)(d.A,{variant:"contained",startIcon:(0,P.jsx)(D.A,{}),onClick:we,fullWidth:C,children:"New Purchase Order (Alt+n)"})]})]}),(0,P.jsx)(c.A,{sx:{mb:3},children:(0,P.jsx)(p.A,{children:(0,P.jsxs)(a.A,{display:"flex",gap:2,flexWrap:"wrap",children:[(0,P.jsx)(u.A,{label:"Search PO (Alt+f)",inputRef:fe,value:K,onChange:e=>V(e.target.value),size:"small",sx:{minWidth:250},InputProps:{startAdornment:(0,P.jsx)(x.A,{position:"start",children:(0,P.jsx)(k.A,{})})}}),(0,P.jsxs)(u.A,{select:!0,label:"Status",value:J,onChange:e=>Y(e.target.value),size:"small",sx:{minWidth:150},children:[(0,P.jsx)(h.A,{value:"all",children:"All Status"}),(0,P.jsx)(h.A,{value:"draft",children:"Draft"}),(0,P.jsx)(h.A,{value:"sent",children:"Sent"}),(0,P.jsx)(h.A,{value:"partially_received",children:"Receiving"}),(0,P.jsx)(h.A,{value:"received",children:"Completed"})]}),(0,P.jsxs)(u.A,{select:!0,label:"Supplier",value:G,onChange:e=>X(e.target.value),size:"small",sx:{minWidth:200},children:[(0,P.jsx)(h.A,{value:"all",children:"All Suppliers"}),U.map(e=>(0,P.jsx)(h.A,{value:e.id,children:e.name},e.id))]})]})})}),(0,P.jsx)(c.A,{children:(0,P.jsx)(m.A,{sx:{overflowX:"auto",maxWidth:"100%"},children:(0,P.jsxs)(_.A,{sx:{minWidth:900},children:[(0,P.jsx)(g.A,{children:(0,P.jsxs)(A.A,{children:[(0,P.jsx)(f.A,{children:(0,P.jsx)("strong",{children:"PO Number"})}),(0,P.jsx)(f.A,{children:(0,P.jsx)("strong",{children:"Supplier"})}),(0,P.jsx)(f.A,{children:(0,P.jsx)("strong",{children:"Order Date"})}),(0,P.jsx)(f.A,{children:(0,P.jsx)("strong",{children:"Status"})}),(0,P.jsx)(f.A,{align:"right",children:(0,P.jsx)("strong",{children:"Total Amount"})}),(0,P.jsx)(f.A,{align:"right",children:(0,P.jsx)("strong",{children:"Actions"})})]})}),(0,P.jsx)(v.A,{children:M?(0,P.jsx)(A.A,{children:(0,P.jsx)(f.A,{colSpan:6,align:"center",children:"Loading..."})}):0===E.length?(0,P.jsx)(A.A,{children:(0,P.jsx)(f.A,{colSpan:6,align:"center",children:"No purchase orders found"})}):E.map(t=>{var n,r;return(0,P.jsxs)(A.A,{hover:!0,children:[(0,P.jsx)(f.A,{children:(0,P.jsx)(l.A,{variant:"body2",fontWeight:600,children:t.po_number})}),(0,P.jsx)(f.A,{children:(null===(n=t.suppliers)||void 0===n?void 0:n.name)||"\u2014"}),(0,P.jsx)(f.A,{children:new Date(t.order_date).toLocaleDateString()}),(0,P.jsx)(f.A,{children:(0,P.jsx)(j.A,{icon:(r=t.status,{draft:(0,P.jsx)(S.A,{fontSize:"small"}),sent:(0,P.jsx)(R,{fontSize:"small"}),partially_received:(0,P.jsx)(O.A,{fontSize:"small"}),received:(0,P.jsx)(q.A,{fontSize:"small"})}[r]),label:be(t.status),color:ye(t.status),size:"small"})}),(0,P.jsx)(f.A,{align:"right",children:(0,P.jsxs)(l.A,{variant:"body2",fontWeight:600,children:[(null===e||void 0===e?void 0:e.currency_symbol)||"Rs",(0,L.vv)(t.final_amount||t.total_amount,"")]})}),(0,P.jsx)(f.A,{align:"right",children:(0,P.jsxs)(a.A,{display:"flex",gap:1,justifyContent:"flex-end",children:[(0,P.jsx)(y.A,{title:"View Details",children:(0,P.jsx)(b.A,{size:"small",color:"primary",onClick:()=>(e=>{ce(e),le(!0)})(t),children:(0,P.jsx)(F.A,{fontSize:"small"})})}),"draft"===t.status&&(0,P.jsxs)(P.Fragment,{children:[(0,P.jsx)(y.A,{title:"Edit",children:(0,P.jsx)(b.A,{size:"small",color:"secondary",onClick:()=>(e=>{ce(e),se(!0)})(t),children:(0,P.jsx)(S.A,{fontSize:"small"})})}),(0,P.jsx)(y.A,{title:"Delete",children:(0,P.jsx)(b.A,{size:"small",color:"error",onClick:()=>(async e=>{if(window.confirm("Are you sure you want to delete PO ".concat(e.po_number,"?")))try{const{error:t}=await N.N.from("purchase_orders").update({deleted_at:(new Date).toISOString()}).eq("id",e.id);if(t)throw t;W.oR.success("Purchase order deleted!"),ve()}catch(t){console.error("Error deleting PO:",t),W.oR.error("Failed to delete purchase order")}})(t),children:(0,P.jsx)(I.A,{fontSize:"small"})})})]})]})})]},t.id)})})]})})}),(0,P.jsx)(w.A,{rowsPerPageOptions:[10,25,50,100],component:"div",count:ne,rowsPerPage:ee,page:Z,onPageChange:(e,t)=>{$(t)},onRowsPerPageChange:e=>{te(parseInt(e.target.value,10)),$(0)}}),(0,P.jsx)(Q,{open:oe,onClose:(e,t,n)=>{se(!1),e&&t&&n&&(Ae({po:e,items:t,supplier:n}),_e(!0)),ce(null),ve()},purchaseOrder:de,suppliers:U}),(0,P.jsx)(re,{open:ae,onClose:()=>le(!1),purchaseOrder:de,onRefresh:ve}),(0,P.jsx)(pe,{open:me,onClose:()=>_e(!1),purchaseOrder:ge.po,poItems:ge.items,supplier:ge.supplier,settings:e})]})}},70141:(e,t,n)=>{n.d(t,{A:()=>o});var r=n(59662),i=n(70579);const o=(0,r.A)((0,i.jsx)("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"}),"Add")},83560:(e,t,n)=>{n.d(t,{A:()=>o});var r=n(59662),i=n(70579);const o=(0,r.A)((0,i.jsx)("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75z"}),"Edit")},88458:(e,t,n)=>{n.d(t,{JT:()=>i,p0:()=>r});const r=(e,t,n,r)=>{const i=function(e,t,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"Medical Store";if(!e)return null;const i=e.replace(/\D/g,""),o="Hi, this is ".concat(r,'. We need to order "').concat(t,'". Current stock is ').concat(n,". Please let us know availability and price."),s=encodeURIComponent(o);return"https://wa.me/".concat(i,"?text=").concat(s)}(e,t,n,r);i?window.open(i,"_blank"):alert("Supplier phone number is missing!")},i=(e,t)=>{if(!e)return void alert("Phone number is missing!");const n=e.replace(/\D/g,""),r=encodeURIComponent(t),i="https://wa.me/".concat(n,"?text=").concat(r);window.open(i,"_blank")}},98606:(e,t,n)=>{n.d(t,{A:()=>o});var r=n(59662),i=n(70579);const o=(0,r.A)((0,i.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"}),"CheckCircle")}}]);
//# sourceMappingURL=173.19ecb6a1.chunk.js.map